name: studypal

on:
    push:
        branches: [main]

    pull_request:
        branches: [main]

 
        
jobs: 
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code 
              uses: actions/checkout@v2  

            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                username: ${{secrets.DOCKER_USERNAME}}
                password: ${{secrets.DOCKER_PASSWORD}}  

            - name: Building the Docker Image
              run: docker build -t tonnykioko/studypal:latest .
            
            - name: Pushing Image to Docker Hub
              run: docker push tonnykioko/studypal:latest

    

            ## Running on AWS
            - name: Deployment to AWS
              uses: appleboy/ssh-action@master
              with: 
                host: ${{secrets.AWS_IP_ADDRESS}}
                username: ${{secrets.AWS_USER_NAME}}
                key: ${{secrets.AWS_SSH_KEY}}
                script: |
                    docker pull tonnykioko/studypal:latest
                    docker run -p 8000:8000 --name studypalapp studypal:latest


